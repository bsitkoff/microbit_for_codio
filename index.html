<!DOCTYPE html>
<html>
<head>
    <title>micro:bit Python Flasher - V3 Method</title>
    <meta charset="utf-8">
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        button {
            padding: 15px 30px;
            font-size: 16px;
            margin: 10px;
            cursor: pointer;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        #status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            background-color: #f8f9fa;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        #progress {
            width: 100%;
            height: 30px;
            margin-top: 10px;
            display: none;
        }
        #code {
            width: 100%;
            height: 200px;
            font-family: monospace;
            font-size: 14px;
            padding: 10px;
        }
    </style>
</head>
<body>
    <h1>micro:bit Python Flasher (V3 Method)</h1>
    <p>This uses the official Python Editor V3 approach with @microbit/microbit-connection</p>

    <p>File to flash: <strong id="filename">main.py</strong></p>
    <p><small>Specify a different file with ?file=yourfile.py in the URL</small></p>

    <div>
        <button id="connectBtn">Connect to micro:bit</button>
        <button id="flashBtn" disabled>Flash Code</button>
    </div>

    <progress id="progress" value="0" max="100"></progress>

    <div id="status">
        Click "Connect to micro:bit" to begin.
    </div>

    <script type="module">
        // Import from esm.sh which handles dependencies automatically
        import {
            createWebUSBConnection,
            ConnectionStatus
        } from 'https://esm.sh/@microbit/microbit-connection@0.0.0-alpha.36';

        import {
            MicropythonFsHex,
            microbitBoardId
        } from 'https://esm.sh/@microbit/microbit-fs@0.10.0';

        const connectBtn = document.getElementById('connectBtn');
        const flashBtn = document.getElementById('flashBtn');
        const statusDiv = document.getElementById('status');
        const progressBar = document.getElementById('progress');
        const filenameSpan = document.getElementById('filename');

        let connection = null;
        let firmware = null;
        let pythonFile = 'main.py';

        // Get filename from URL parameter
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('file')) {
            pythonFile = urlParams.get('file');
            filenameSpan.textContent = pythonFile;
        }

        // Load the base firmware
        async function loadFirmware() {
            try {
                statusDiv.textContent = 'Loading MicroPython firmware...';
                statusDiv.className = 'info';

                // Use the V2-only firmware we already have
                const response = await fetch('microbit-micropython-v2.hex');
                if (!response.ok) {
                    throw new Error(`Failed to load firmware: ${response.status}`);
                }
                firmware = await response.text();

                statusDiv.textContent = 'Firmware loaded. Click "Connect to micro:bit" to continue.';
                statusDiv.className = '';

                console.log('Firmware loaded, size:', firmware.length, 'bytes');
            } catch (error) {
                statusDiv.textContent = `Error loading firmware: ${error.message}`;
                statusDiv.className = 'error';
                console.error('Firmware load error:', error);
            }
        }

        // Initialize connection
        function initConnection() {
            connection = createWebUSBConnection({
                logging: {
                    log: (message) => console.log('[microbit]', message),
                    event: (evt) => console.log('[event]', evt),
                }
            });

            connection.addEventListener('status', (event) => {
                console.log('Connection status:', event.status);
                updateUIForStatus(event.status);
            });
        }

        function updateUIForStatus(status) {
            switch (status) {
                case ConnectionStatus.CONNECTED:
                    statusDiv.textContent = 'Connected to micro:bit!';
                    statusDiv.className = 'success';
                    flashBtn.disabled = false;
                    connectBtn.textContent = 'Disconnect';
                    break;
                case ConnectionStatus.DISCONNECTED:
                    statusDiv.textContent = 'Disconnected. Click "Connect" to reconnect.';
                    statusDiv.className = '';
                    flashBtn.disabled = true;
                    connectBtn.textContent = 'Connect to micro:bit';
                    break;
                case ConnectionStatus.NOT_SUPPORTED:
                    statusDiv.textContent = 'WebUSB not supported in this browser. Use Chrome or Edge.';
                    statusDiv.className = 'error';
                    connectBtn.disabled = true;
                    break;
            }
        }

        // Connect button handler
        connectBtn.addEventListener('click', async () => {
            if (!connection) {
                statusDiv.textContent = 'Initializing...';
                statusDiv.className = 'info';
                return;
            }

            try {
                if (connection.status === ConnectionStatus.CONNECTED) {
                    await connection.disconnect();
                } else {
                    statusDiv.textContent = 'Requesting device access...';
                    statusDiv.className = 'info';
                    await connection.connect();
                }
            } catch (error) {
                statusDiv.textContent = `Connection error: ${error.message}`;
                statusDiv.className = 'error';
                console.error('Connection error:', error);
            }
        });

        // Flash button handler
        flashBtn.addEventListener('click', async () => {
            if (!firmware) {
                statusDiv.textContent = 'Firmware not loaded yet. Please wait...';
                statusDiv.className = 'error';
                return;
            }

            try {
                flashBtn.disabled = true;
                connectBtn.disabled = true;
                progressBar.style.display = 'block';
                progressBar.value = 0;

                statusDiv.textContent = `Reading ${pythonFile}...`;
                statusDiv.className = 'info';

                // Read the Python file from the filesystem
                const response = await fetch(pythonFile);
                if (!response.ok) {
                    throw new Error(`Failed to read ${pythonFile}: ${response.statusText}`);
                }
                const code = await response.text();

                statusDiv.textContent = 'Preparing hex file with your code...';
                statusDiv.className = 'info';

                // Create filesystem hex with the user's code
                // Pass as array with board ID to match the connected device
                const boardId = microbitBoardId.V2; // 0x9903 for V2
                const fs = new MicropythonFsHex([{ hex: firmware, boardId: boardId }]);
                fs.write('main.py', code);

                // Create the data source function
                const dataSource = async (boardVersion) => {
                    console.log('Generating hex for board version:', boardVersion);
                    // Return the hex for the board ID we initialized with
                    return fs.getIntelHex(boardId);
                };

                statusDiv.textContent = 'Flashing to micro:bit...';

                // Flash with partial flashing enabled
                await connection.flash(dataSource, {
                    partial: true,
                    progress: (value, partial) => {
                        if (value !== undefined) {
                            progressBar.value = value * 100;
                            statusDiv.textContent = `Flashing... ${Math.round(value * 100)}% (${partial ? 'partial' : 'full'} flash)`;
                        }
                    }
                });

                progressBar.style.display = 'none';
                statusDiv.textContent = 'Flash complete! Your code is running on the micro:bit.';
                statusDiv.className = 'success';

            } catch (error) {
                progressBar.style.display = 'none';
                statusDiv.textContent = `Flash error: ${error.message}`;
                statusDiv.className = 'error';
                console.error('Flash error:', error);
            } finally {
                flashBtn.disabled = false;
                connectBtn.disabled = false;
            }
        });

        // Initialize on page load
        (async () => {
            await loadFirmware();
            initConnection();
        })();
    </script>
</body>
</html>
